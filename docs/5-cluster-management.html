<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Cluster Management – The Elastic Certified Engineer Exam v8.1 Study Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./6-appendix.html" rel="next">
<link href="./4-data-processing.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./5-cluster-management.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Cluster Management</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">The Elastic Certified Engineer Exam v8.1 Study Guide</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0.1-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0.2-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1-data-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2-searching-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Searching Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3-developing-search-applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Developing Search Applications</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4-data-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Processing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5-cluster-management.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Cluster Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#task-diagnose-shard-issues-and-repair-a-clusters-health" id="toc-task-diagnose-shard-issues-and-repair-a-clusters-health" class="nav-link active" data-scroll-target="#task-diagnose-shard-issues-and-repair-a-clusters-health"><span class="header-section-number">5.1</span> Task: Diagnose shard issues and repair a cluster's health</a>
  <ul class="collapse">
  <li><a href="#example-1-identifying-and-resolving-unassigned-shards-to-improve-cluster-health" id="toc-example-1-identifying-and-resolving-unassigned-shards-to-improve-cluster-health" class="nav-link" data-scroll-target="#example-1-identifying-and-resolving-unassigned-shards-to-improve-cluster-health">Example 1: Identifying and resolving unassigned shards to improve cluster health</a></li>
  <li><a href="#example-2-identifying-and-resolving-a-shard-failure-in-a-cluster" id="toc-example-2-identifying-and-resolving-a-shard-failure-in-a-cluster" class="nav-link" data-scroll-target="#example-2-identifying-and-resolving-a-shard-failure-in-a-cluster">Example 2: Identifying and resolving a shard failure in a cluster</a></li>
  </ul></li>
  <li><a href="#task-backup-and-restore-a-cluster-andor-specific-indices" id="toc-task-backup-and-restore-a-cluster-andor-specific-indices" class="nav-link" data-scroll-target="#task-backup-and-restore-a-cluster-andor-specific-indices"><span class="header-section-number">5.2</span> Task: Backup and restore a cluster and/or specific indices</a>
  <ul class="collapse">
  <li><a href="#example-1-create-a-snapshot-of-multiple-indices-and-and-restore-them" id="toc-example-1-create-a-snapshot-of-multiple-indices-and-and-restore-them" class="nav-link" data-scroll-target="#example-1-create-a-snapshot-of-multiple-indices-and-and-restore-them">Example 1: Create a snapshot of multiple indices and and restore them</a></li>
  <li><a href="#example-2-create-a-snapshot-of-an-entire-cluster-and-restore-a-single-index" id="toc-example-2-create-a-snapshot-of-an-entire-cluster-and-restore-a-single-index" class="nav-link" data-scroll-target="#example-2-create-a-snapshot-of-an-entire-cluster-and-restore-a-single-index">Example 2: Create a snapshot of an entire cluster and restore a single index</a></li>
  <li><a href="#example-3-creating-a-snapshot-of-a-single-index-and-restoring-it" id="toc-example-3-creating-a-snapshot-of-a-single-index-and-restoring-it" class="nav-link" data-scroll-target="#example-3-creating-a-snapshot-of-a-single-index-and-restoring-it">Example 3: Creating a snapshot of a single index and restoring it</a></li>
  </ul></li>
  <li><a href="#task-configure-a-snapshot-to-be-searchable" id="toc-task-configure-a-snapshot-to-be-searchable" class="nav-link" data-scroll-target="#task-configure-a-snapshot-to-be-searchable"><span class="header-section-number">5.3</span> Task: Configure a snapshot to be searchable</a>
  <ul class="collapse">
  <li><a href="#example-1-creating-a-searchable-snapshot-for-the-product-catalog-index" id="toc-example-1-creating-a-searchable-snapshot-for-the-product-catalog-index" class="nav-link" data-scroll-target="#example-1-creating-a-searchable-snapshot-for-the-product-catalog-index">Example 1: Creating a searchable snapshot for the product catalog index</a></li>
  </ul></li>
  <li><a href="#task-configure-a-cluster-for-cross-cluster-search" id="toc-task-configure-a-cluster-for-cross-cluster-search" class="nav-link" data-scroll-target="#task-configure-a-cluster-for-cross-cluster-search"><span class="header-section-number">5.4</span> Task: Configure a cluster for cross-cluster search</a>
  <ul class="collapse">
  <li><a href="#example-1-setting-up-cross-cluster-search-between-a-local-cluster-and-a-remote-cluster-for-an-e-commerce-catalog" id="toc-example-1-setting-up-cross-cluster-search-between-a-local-cluster-and-a-remote-cluster-for-an-e-commerce-catalog" class="nav-link" data-scroll-target="#example-1-setting-up-cross-cluster-search-between-a-local-cluster-and-a-remote-cluster-for-an-e-commerce-catalog">Example 1: Setting up cross-cluster search between a local cluster and a remote cluster for an e-commerce catalog</a></li>
  </ul></li>
  <li><a href="#task-implement-cross-cluster-replication" id="toc-task-implement-cross-cluster-replication" class="nav-link" data-scroll-target="#task-implement-cross-cluster-replication"><span class="header-section-number">5.5</span> Task: Implement cross-cluster replication</a>
  <ul class="collapse">
  <li><a href="#example-1-setting-up-cross-cluster-replication-for-the-product-catalog-index-between-a-leader-cluster-and-a-follower-cluster" id="toc-example-1-setting-up-cross-cluster-replication-for-the-product-catalog-index-between-a-leader-cluster-and-a-follower-cluster" class="nav-link" data-scroll-target="#example-1-setting-up-cross-cluster-replication-for-the-product-catalog-index-between-a-leader-cluster-and-a-follower-cluster">Example 1: Setting up cross-cluster replication for the product catalog index between a leader cluster and a follower cluster</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Cluster Management</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="task-diagnose-shard-issues-and-repair-a-clusters-health" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="task-diagnose-shard-issues-and-repair-a-clusters-health"><span class="header-section-number">5.1</span> Task: Diagnose shard issues and repair a cluster's health</h2>
<p>While the odds are rather high that you will have some unassigned shards if you have done enough of the examples and not cleaned up after yourself we will artifically create some so the below will make some degree of sense.</p>
<section id="example-1-identifying-and-resolving-unassigned-shards-to-improve-cluster-health" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-1-identifying-and-resolving-unassigned-shards-to-improve-cluster-health">Example 1: Identifying and resolving unassigned shards to improve cluster health</h3>
<section id="requirements" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements">Requirements</h4>
<ul>
<li>Identify the cause of unassigned shards.</li>
<li>Reassign shards to nodes to improve cluster health.</li>
<li>Ensure all indices are properly allocated and the cluster health status is green.</li>
</ul>
</section>
<section id="steps" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps">Steps</h4>
<ol type="1">
<li><p><strong>Open the Kibana Console</strong> or use a REST client</p></li>
<li><p>Create an index that needs more replicas than available nodes</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/a-bad-index</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"number_of_shards"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"number_of_replicas"</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the cluster health and identify unassigned shards (you should see at least 2 unassigned shards)</p></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/cluster-management-task1-ex-1-p1.png" class="img-fluid figure-img"></p>
<figcaption>Number of unassigned shards</figcaption>
</figure>
</div>
<ol start="4" type="1">
<li><p>List the unassigned shards (you should see the index name created above with 2 messages of UNASSIGNED)</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">_cat/shards?v=true&amp;h=index,shard,prirep,state,node,unassigned.reason&amp;s=state</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/cluster-management-task1-ex-1-p2.png" class="img-fluid figure-img"></p>
<figcaption>Names of the unassigned shards</figcaption>
</figure>
</div></li>
<li><p>Identify the reason for the unassigned shards</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">_cluster/allocation/explain</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"index"</span><span class="fu">:</span> <span class="st">"a-bad-index"</span><span class="fu">,</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shard"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"primary"</span><span class="fu">:</span> <span class="kw">true</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>In the scenario where you are running an Elasticsearch cluster locally and only have one node then you simply have to lower the number of replicas</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/a-bad-index/_settings</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"number_of_replicas"</span><span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running the shard check again will show that the unassigned shards are now gone.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">_cat/shards?v=true&amp;h=index,shard,prirep,state,node,unassigned.reason&amp;s=state</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/cluster-management-task1-ex-1-p3.png" class="img-fluid figure-img"></p>
<figcaption>The unassigned shards are gone</figcaption>
</figure>
</div></li>
<li><p>Verify the cluster health again</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test">Test</h4>
<ol type="1">
<li><p>Check the cluster health status</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Ensure there are no unassigned shards</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cat/shards?v&amp;h=index,shard,prirep,state,unassigned.reason,node</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations">Considerations</h4>
<ul>
<li>The cluster reroute command should be used carefully, especially when accepting data loss.</li>
<li>Force merging should be done during low traffic periods as it is resource-intensive.</li>
<li>Regularly monitoring cluster health can prevent shard allocation issues.</li>
</ul>
</section>
<section id="documentation" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation">Documentation</h4>
<p>Start here:</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/diagnose-unassigned-shards.html" target="_blank">Diagnose Unassigned Shards</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/red-yellow-cluster-status.html" target="_blank">Red or Yellow Cluster Health Status</a></li>
</ul>
<p>For more detail:</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-shards.html" target="_blank">Cat Shards API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" target="_blank">Cluster Health API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html" target="_blank">Cluster Reroute API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-forcemerge.html" target="_blank">Force Merge API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html" target="_blank">Nodes Stats API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/troubleshooting.html" target="_blank">Troubleshooting</a></li>
</ul>
</section>
</section>
<section id="example-2-identifying-and-resolving-a-shard-failure-in-a-cluster" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-2-identifying-and-resolving-a-shard-failure-in-a-cluster">Example 2: Identifying and resolving a shard failure in a cluster</h3>
<section id="requirements-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-1">Requirements</h4>
<ul>
<li>Identify the cause of a shard failure</li>
<li>Resolve the issue and restore the cluster’s health</li>
</ul>
</section>
<section id="steps-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-1">Steps</h4>
<ol type="1">
<li><p><strong>Open the Kibana Console</strong> or use a REST client</p></li>
<li><p>Check the cluster’s health</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Identify the index and shard with issues</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cat/shards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the shard’s status</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cat/shards/</span><span class="fu">{</span><span class="er">index_name</span><span class="fu">}</span><span class="er">-</span><span class="fu">{</span><span class="er">shard_number</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Resolve the issue (e.g., restart a node, reassign the shard)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_cluster/reroute</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"commands"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"move"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"index"</span><span class="fu">:</span> <span class="st">"{index_name}"</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"shard"</span><span class="fu">:</span> <span class="fu">{</span><span class="er">shard_number</span><span class="fu">},</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"from_node"</span><span class="fu">:</span> <span class="st">"{node_name}"</span><span class="fu">,</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"to_node"</span><span class="fu">:</span> <span class="st">"{new_node_name}"</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the cluster’s health</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-1">Test</h4>
<ul>
<li><p>Verify that the shard is no longer in a failed state</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cat/shards/</span><span class="fu">{</span><span class="er">index_name</span><span class="fu">}</span><span class="er">-</span><span class="fu">{</span><span class="er">shard_number</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="considerations-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-1">Considerations</h4>
<ul>
<li>Regularly monitoring the cluster’s health can help identify issues before they become critical.</li>
<li>Understanding the cause of the shard failure is crucial to resolving the issue effectively.</li>
</ul>
</section>
<section id="documentation-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-1">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" target="_blank">Cluster Health</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html" target="_blank">Cluster-level Shard Allocation and Routing Settings</a></li>
</ul>
</section>
</section>
</section>
<section id="task-backup-and-restore-a-cluster-andor-specific-indices" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="task-backup-and-restore-a-cluster-andor-specific-indices"><span class="header-section-number">5.2</span> Task: Backup and restore a cluster and/or specific indices</h2>
<p>This example is specific to a local Elasticsearch cluster, not the Elastic Cloud version. I would recommend learning how to set up a backup and restore from the Kibana UI at <strong>Home &gt; Management &gt; Data &gt; Snapshot and Restore</strong>. I didn’t find any documentation on the use of the Kibana dashboard to perform backups and restores.</p>
<section id="example-1-create-a-snapshot-of-multiple-indices-and-and-restore-them" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-1-create-a-snapshot-of-multiple-indices-and-and-restore-them">Example 1: Create a snapshot of multiple indices and and restore them</h3>
<p>This example is specific to a local Elasticsearch cluster, not the Elastic Cloud version. I would recommend learning how to set up a backup and restore from the Kibana UI at <strong>Home &gt; Management &gt; Data &gt; Snapshot and Restore</strong>. I didn’t find any documentation on the use of the Kibana dashboard to perform backups and restores.</p>
<section id="requirements-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-2">Requirements</h4>
<ul>
<li>Back up the entire Elasticsearch cluster (all the indices on the cluster)</li>
<li>Restore specific indices from the backup</li>
</ul>
</section>
<section id="steps-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-2">Steps</h4>
<ol type="1">
<li><p><em>(Do this is you haven’t already done it due to a previous exercise)</em> Configure the <strong>es01</strong> container instance with a backups directory</p>
<ol type="1">
<li><p>In a terminal execute bash on the docker container</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker exec <span class="at">-it</span> es01 /bin/bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a backup directory in the current directory of the container</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> backups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you change directory to <code>backups</code> and run <code>pwd</code> you’ll find that the full path is <code>/usr/share/elasticsearch/backups</code>.</p></li>
<li><p>Exit the container shell</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Update the elasticsearch.yml <code>path.repo</code> variable and restart the cluster</p>
<ol type="1">
<li><p>When we created two single-node clusters (Appendix: Setting Up An Additional Single-node Cluster for Cross-cluster Search (CCS)) we renamed the YAML files for the two cluster:</p>
<ul>
<li>elasticsearch-es01.yml</li>
<li>elasticsearch-es02.yml</li>
</ul>
<p>For the purposes of this example update <strong>elasticsearch-es01.yml</strong>.</p></li>
</ol>
<div class="sourceCode" id="cb19"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.repo</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"/usr/share/elasticsearch/backups"</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Copy the YAML file back into the container</li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker cp elasticsearch-es01.yml es01:/usr/share/elasticsearch/config/elasticsearch.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Restart <strong>es01</strong></li>
</ol></li>
</ol></li>
<li><p><strong>Open the Kibana Console</strong> or use a REST client.</p></li>
<li><p>Create two sample indexes with some data</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.1"</span> <span class="fu">}</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.2"</span> <span class="fu">}</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.1"</span> <span class="fu">}</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.2"</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Confirm the documents were indexed</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">example_index*/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot repository</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/example_index_backup</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"fs"</span><span class="fu">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"location"</span><span class="fu">:</span> <span class="st">"/usr/share/elasticsearch/backups"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot of the two example indices</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/example_index_backup/snapshot_1</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"example_index1,example_index2"</span><span class="fu">,</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ignore_unavailable"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"include_global_state"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the snapshot status</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_snapshot/example_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the two known indices</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check that the two indexes are gone.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/example_index*/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Restore both indices from the snapshot</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/example_index_backup/snapshot_1/_restore</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Confirm both indices were restored</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/example_index*/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Restore one index from the snapshot</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/example_index_backup/snapshot_1/_restore</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"ignore_unavailable"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"include_global_state"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-2">Test</h4>
<ol type="1">
<li><p>Verify the index has been restored</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/example_index2/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the integrity of the snapshot</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/example_index_backup/_verify</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the cluster health to ensure the index is properly allocated</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health/example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-2">Considerations</h4>
<ul>
<li>The snapshot repository is configured with the fs (file system) type, which stores the backup data in the container’s local file system. For production use, you may want to use a more suitable repository type, such as s3 or gcs.</li>
<li>The snapshot name snapshot_1 is used to create a backup of the two indices.</li>
</ul>
</section>
<section id="clean-up-optional" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional">Clean-up (optional)</h4>
<ul>
<li><p>Delete the indices</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the Backup</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/_snapshot/example_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-2">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html" target="_blank">Snapshot and Restore</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-repositories.html" target="_blank">Snapshot Repository APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html#snapshot-restore">Snapshot Restore API</a></li>
</ul>
</section>
</section>
<section id="example-2-create-a-snapshot-of-an-entire-cluster-and-restore-a-single-index" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-2-create-a-snapshot-of-an-entire-cluster-and-restore-a-single-index">Example 2: Create a snapshot of an entire cluster and restore a single index</h3>
<section id="requirements-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-3">Requirements</h4>
<ul>
<li>Back up the entire Elasticsearch cluster</li>
<li>Restore specific indices from the backup</li>
</ul>
</section>
<section id="steps-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-3">Steps</h4>
<ol type="1">
<li><p><em>(Do this is you haven’t already done it due to a previous exercise)</em> Configure the <strong>es01</strong> container instance with a backups directory</p>
<ol type="1">
<li><p>In a terminal execute bash on the docker container</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker exec <span class="at">-it</span> es01 /bin/bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a backup directory in the current directory of the container</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> backups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you change directory to <code>backups</code> and run <code>pwd</code> you’ll find that the full path is <code>/usr/share/elasticsearch/backups</code>.</p></li>
<li><p>Exit the container shell</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Update the elasticsearch.yml <code>path.repo</code> variable and restart the cluster</p>
<ol type="1">
<li><p>When we created two single-node clusters (Appendix: Setting Up An Additional Single-node Cluster for Cross-cluster Search (CCS)) we renamed the YAML files for the two cluster:</p>
<ul>
<li>elasticsearch-es01.yml</li>
<li>elasticsearch-es02.yml</li>
</ul>
<p>For the purposes of this example update <strong>elasticsearch-es01.yml</strong>.</p></li>
</ol>
<div class="sourceCode" id="cb40"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.repo</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"/usr/share/elasticsearch/backups"</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Copy the YAML file back into the container</li>
</ol>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker cp elasticsearch-es01.yml es01:/usr/share/elasticsearch/config/elasticsearch.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Restart <strong>es01</strong></li>
</ol></li>
</ol></li>
<li><p><strong>Open the Kibana Console</strong> or use a REST client.</p></li>
<li><p>Create two sample indexes with some data</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.1"</span> <span class="fu">}</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.2"</span> <span class="fu">}</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.1"</span> <span class="fu">}</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.2"</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Confirm the documents were indexed</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">example_index*/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot repository</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/example_cluster_backup</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"fs"</span><span class="fu">,</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"location"</span><span class="fu">:</span> <span class="st">"/usr/share/elasticsearch/backups"</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot of the entire cluster</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/example_cluster_backup/full_cluster_backup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the snapshot status</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_snapshot/example_cluster_backup/full_cluster_backup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete one of the existing indices</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Restore that specific index from the snapshot with a different name</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/example_cluster_backup/full_cluster_backup/_restore</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"rename_pattern"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"rename_replacement"</span><span class="fu">:</span> <span class="st">"restored_example_index2"</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-3">Test</h4>
<ol type="1">
<li><p>Verify the index has been restored</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/restored_example_index2/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The response should include the documents from the original <code>example_index2</code>.</p></li>
<li><p>Optionally, you can delete the original index and verify that the restored index remains</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/restored_example_index2/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the integrity of the snapshot</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/example_cluster_backup/_verify</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the cluster health to ensure the index is properly allocated</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health/restored_example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-3">Considerations</h4>
<ul>
<li>The snapshot repository is configured with the <strong>fs</strong> (file system) type, which stores the backup data in the container’s local file system. For production use, you may want to use a more suitable repository type, such as s3 or gcs.</li>
<li>The snapshot name full_cluster_backup is used to create a backup of the entire cluster.</li>
<li>During the restore process, the <code>rename_pattern</code> and <code>rename_replacement</code> options are used to rename the restored index to <code>restored_example_index2</code>.</li>
</ul>
</section>
<section id="clean-up-optional-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional-1">Clean-up (optional)</h4>
<ul>
<li><p>Delete the indices</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/restored_example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the backup</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/_snapshot/example_cluster_backup/full_cluster_backup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-3">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html" target="_blank">Snapshot and Restore</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-repositories.html" target="_blank">Snapshot Repository APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html#snapshot-restore">Snapshot Restore API</a></li>
</ul>
</section>
</section>
<section id="example-3-creating-a-snapshot-of-a-single-index-and-restoring-it" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-3-creating-a-snapshot-of-a-single-index-and-restoring-it">Example 3: Creating a snapshot of a single index and restoring it</h3>
<section id="requirements-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-4">Requirements</h4>
<ul>
<li>Create a repository for storing snapshots.</li>
<li>Take a snapshot of the specified index.</li>
<li>Restore the snapshot to the cluster.</li>
<li>Verify the integrity and availability of the restored data.</li>
</ul>
</section>
<section id="steps-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-4">Steps</h4>
<ol type="1">
<li><p><em>(Do this is you haven’t already done it due to a previous exercise)</em> Configure the <strong>es01</strong> container instance with a backups directory</p>
<ol type="1">
<li><p>In a terminal execute bash on the docker container</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker exec <span class="at">-it</span> es01 /bin/bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a backup directory in the current directory of the container</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> backups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you change directory to <code>backups</code> and run <code>pwd</code> you’ll find that the full path is <code>/usr/share/elasticsearch/backups</code>.</p></li>
<li><p>Exit the container shell</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Update the elasticsearch.yml <code>path.repo</code> variable and restart the cluster</p>
<ol type="1">
<li><p>When we created two single-node clusters (Appendix: Setting Up An Additional Single-node Cluster for Cross-cluster Search (CCS)) we renamed the YAML files for the two cluster:</p>
<ul>
<li>elasticsearch-es01.yml</li>
<li>elasticsearch-es02.yml</li>
</ul>
<p>For the purposes of this example update <strong>elasticsearch-es01.yml</strong>.</p></li>
</ol>
<div class="sourceCode" id="cb59"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.repo</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"/usr/share/elasticsearch/backups"</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Copy the YAML file back into the container</li>
</ol>
<div class="sourceCode" id="cb60"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker cp elasticsearch-es01.yml es01:/usr/share/elasticsearch/config/elasticsearch.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Restart <strong>es01</strong></li>
</ol></li>
</ol></li>
<li><p><strong>Open the Kibana Console</strong> or use a REST client</p></li>
<li><p>Create two sample indexes with some data</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.1"</span> <span class="fu">}</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 1.2"</span> <span class="fu">}</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_bulk</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.1"</span> <span class="fu">}</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"example_index2"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Document 2.2"</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Confirm the documents were indexed</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">example_index*/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot repository</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/single_index_backup</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"fs"</span><span class="fu">,</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"location"</span><span class="fu">:</span> <span class="st">"/usr/share/elasticsearch/backups"</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Take a snapshot of the specific index</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/single_index_backup/snapshot_1</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ignore_unavailable"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"include_global_state"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the snapshot status</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_snapshot/single_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the index to simulate data loss (optional for testing restore)</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Restore the snapshot</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/single_index_backup/snapshot_1/_restore</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"example_index1"</span><span class="fu">,</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ignore_unavailable"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"include_global_state"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-4">Test</h4>
<ol type="1">
<li><p>Verify the index has been restored</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/example_index1/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the integrity of the snapshot</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/_snapshot/single_index_backup/_verify</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the cluster health to ensure the index is properly allocated</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health/example_index1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-4">Considerations</h4>
<ul>
<li>The repository type fs is used for simplicity; other types like s3 can be used depending on the environment.</li>
<li><code>ignore_unavailable</code> ensures the snapshot process continues even if some indices are missing.</li>
<li><code>include_global_state</code> is set to false to avoid restoring cluster-wide settings unintentionally.</li>
</ul>
</section>
<section id="clean-up-optional-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional-2">Clean-up (optional)</h4>
<ul>
<li><p>Delete the indices</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index1</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/example_index2</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/restored_example_index2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the Backup</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/_snapshot/single_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-4">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots.html" target="_blank">Snapshot and Restore</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html" target="_blank">Create Snapshot API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html" target="_blank">Restore Snapshot API</a></li>
</ul>
</section>
</section>
</section>
<section id="task-configure-a-snapshot-to-be-searchable" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="task-configure-a-snapshot-to-be-searchable"><span class="header-section-number">5.3</span> Task: Configure a snapshot to be searchable</h2>
<section id="example-1-creating-a-searchable-snapshot-for-the-product-catalog-index" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-1-creating-a-searchable-snapshot-for-the-product-catalog-index">Example 1: Creating a searchable snapshot for the product catalog index</h3>
<p>This can also be done through the <strong>Home &gt; Management &gt; Data &gt; Index Lifecycle Mangement UI</strong>. Again, no documentation on how to perform this using the Kibana dashboard.</p>
<p><em>Sigh.</em> This will only work if you have an <strong>Enterprise</strong> license.</p>
<section id="requirements-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-5">Requirements</h4>
<ul>
<li>Create a repository for storing snapshots.</li>
<li>Take a snapshot of the specified index.</li>
<li>Mount the snapshot as a searchable index.</li>
<li>Verify the index is searchable without restoring it to the cluster.</li>
</ul>
</section>
<section id="steps-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-5">Steps</h4>
<ol type="1">
<li><p><em>(Do this is you haven’t already done it due to a previous exercise)</em> Configure the <strong>es01</strong> container instance with a backups directory</p>
<ol type="1">
<li><p>In a terminal execute bash on the docker container</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker exec <span class="at">-it</span> es01 /bin/bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a backup directory in the current directory of the container</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> backups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you change directory to <code>backups</code> and run <code>pwd</code> you’ll find that the full path is <code>/usr/share/elasticsearch/backups</code>.</p></li>
<li><p>Exit the container shell</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Update the elasticsearch.yml <code>path.repo</code> variable and restart the cluster</p>
<ol type="1">
<li><p>When we created two single-node clusters (Appendix: Setting Up An Additional Single-node Cluster for Cross-cluster Search (CCS)) we renamed the YAML files for the two cluster:</p>
<ul>
<li>elasticsearch-es01.yml</li>
<li>elasticsearch-es02.yml</li>
</ul>
<p>For the purposes of this example update <strong>elasticsearch-es01.yml</strong>.</p></li>
</ol>
<div class="sourceCode" id="cb76"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.repo</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"/usr/share/elasticsearch/backups"</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Copy the YAML file back into the container</li>
</ol>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker cp elasticsearch-es01.yml es01:/usr/share/elasticsearch/config/elasticsearch.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Restart <strong>es01</strong></li>
</ol></li>
</ol></li>
<li><p><strong>Open the Kibana Console</strong> or use a REST client.</p></li>
<li><p>Create a sample index with some data</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">_bulk</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Laptop"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Electronics"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">999.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">50</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"A high-performance laptop with 16GB RAM and 512GB SSD."</span> <span class="fu">}</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Smartphone"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Electronics"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">699.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"A latest model smartphone with a stunning display and powerful processor."</span> <span class="fu">}</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"3"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Headphones"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Accessories"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">199.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">200</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Noise-cancelling over-ear headphones with superior sound quality."</span> <span class="fu">}</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"4"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Coffee Maker"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Home Appliances"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">89.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">75</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"A programmable coffee maker with a 12-cup capacity."</span> <span class="fu">}</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"5"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Running Shoes"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Footwear"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">129.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">150</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Lightweight running shoes with excellent cushioning and support."</span> <span class="fu">}</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"6"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Backpack"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Accessories"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">49.99</span><span class="fu">,</span> <span class="dt">"stock"</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Durable backpack with multiple compartments and ergonomic design."</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Confirm the documents were indexed</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">products/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a snapshot repository</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/products_index_backup</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"fs"</span><span class="fu">,</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"location"</span><span class="fu">:</span> <span class="st">"/usr/share/elasticsearch/backups"</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Take a snapshot of the specific index</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/products_index_backup/snapshot_1</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"indices"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"ignore_unavailable"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"include_global_state"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the snapshot status</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_snapshot/products_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the index to simulate data loss (optional for testing restore)</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/products</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Mount the snapshot as a searchable index</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_snapshot/products_index_backup/snapshot_1/_mount</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"index"</span><span class="fu">:</span> <span class="st">"products"</span><span class="fu">,</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"renamed_index"</span><span class="fu">:</span> <span class="st">"products_backup_searchable"</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you don’t have an <strong>Enterprise</strong> license the above will fail.</p></li>
</ol>
</section>
<section id="test-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-5">Test</h4>
<ol type="1">
<li><p>Verify the mounted index is searchable</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/products_backup_searchable/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the cluster health to ensure the searchable snapshot is properly allocated</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_cluster/health/products_backup_searchable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-5">Considerations</h4>
<ul>
<li>The repository type fs is used for simplicity; other types like s3 can be used depending on the environment.</li>
<li><code>ignore_unavailable</code> ensures the snapshot process continues even if some indices are missing.</li>
<li><code>include_global_state</code> is set to false to avoid restoring cluster-wide settings unintentionally.</li>
<li>Mounting the snapshot as a searchable index allows for searching the data without the need to fully restore it, saving resources and time.</li>
</ul>
</section>
<section id="clean-up-optional-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional-3">Clean-up (optional)</h4>
<ul>
<li><p>Delete the index</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/products</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the Backup</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">/_snapshot/products_index_backup/snapshot_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-5">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html" target="_blank">Create Snapshot API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/searchable-snapshots-api-mount-snapshot.html" target="_blank">Mount Searchable Snapshot API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html" target="_blank">Search API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-searchable-snapshot.html" target="_blank">Searchable Snapshot</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots.html" target="_blank">Snapshot and Restore</a></li>
</ul>
</section>
</section>
</section>
<section id="task-configure-a-cluster-for-cross-cluster-search" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="task-configure-a-cluster-for-cross-cluster-search"><span class="header-section-number">5.4</span> Task: Configure a cluster for cross-cluster search</h2>
<p>FYI: This is similar to the example at <em>Searching Data &gt; Write and execute a query that searches across multiple clusters</em></p>
<section id="example-1-setting-up-cross-cluster-search-between-a-local-cluster-and-a-remote-cluster-for-an-e-commerce-catalog" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-1-setting-up-cross-cluster-search-between-a-local-cluster-and-a-remote-cluster-for-an-e-commerce-catalog">Example 1: Setting up cross-cluster search between a local cluster and a remote cluster for an e-commerce catalog</h3>
<p>The following instructions are for two single-node clusters running locally on your computer.</p>
<section id="requirements-6" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-6">Requirements</h4>
<ul>
<li>Configure the remote cluster to be searchable from the local cluster.</li>
<li>Ensure secure communication between clusters.</li>
<li>Verify the cross-cluster search functionality.</li>
</ul>
</section>
<section id="steps-6" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-6">Steps</h4>
<ol type="1">
<li><p><strong>Open the Kibana Console</strong> or use a REST client.</p></li>
<li><p>Configure the remote cluster on the local cluster</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_cluster/settings</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="dt">"persistent"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"cluster"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"remote"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"es01"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"seeds"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"es01:9300"</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"skip_unavailable"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"es02"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"seeds"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"es02:9300"</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"skip_unavailable"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>(optional if you are doing this locally) Set up security settings where you have keystores properly setup. On the remote cluster:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_cluster/settings</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"persistent"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.enabled"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.enabled"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.verification_mode"</span><span class="fu">:</span> <span class="st">"certificate"</span><span class="fu">,</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.keystore.path"</span><span class="fu">:</span> <span class="st">"/path/to/keystore.jks"</span><span class="fu">,</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.truststore.path"</span><span class="fu">:</span> <span class="st">"/path/to/truststore.jks"</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the local cluster:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_cluster/settings</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"persistent"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.enabled"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.enabled"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.verification_mode"</span><span class="fu">:</span> <span class="st">"certificate"</span><span class="fu">,</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.keystore.path"</span><span class="fu">:</span> <span class="st">"/path/to/keystore.jks"</span><span class="fu">,</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"xpack.security.transport.ssl.truststore.path"</span><span class="fu">:</span> <span class="st">"/path/to/truststore.jks"</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Verify the remote cluster configuration</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_remote/info</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Index product documents into each cluster.</p></li>
</ol>
<ul>
<li><p>For <strong>es01</strong> (potentially the local cluster):</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/products/_bulk</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product"</span><span class="fu">:</span> <span class="st">"Elasticsearch Guide"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Books"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">29.99</span> <span class="fu">}</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product"</span><span class="fu">:</span> <span class="st">"Advanced Elasticsearch"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Books"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">39.99</span> <span class="fu">}</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"3"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product"</span><span class="fu">:</span> <span class="st">"Elasticsearch T-shirt"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Apparel"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">19.99</span> <span class="fu">}</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"4"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product"</span><span class="fu">:</span> <span class="st">"Elasticsearch Mug"</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Apparel"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">12.99</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>For <strong>es02</strong> (potentially the “remote” cluster) through the command line:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-u</span> elastic:[your password here] <span class="at">-X</span> POST <span class="st">"http://localhost:9201/products/_bulk?pretty"</span> <span class="at">-H</span> <span class="st">'Content-Type: application/json'</span> <span class="at">-d</span><span class="st">'</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="st">{ "index": { "_id": "5" } }</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="st">{ "product": "Elasticsearch Stickers", "category": "Accessories", "price": 4.99 }</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="st">{ "index": { "_id": "6" } }</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="st">{ "product": "Elasticsearch Notebook", "category": "Stationery", "price": 7.99 }</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="st">{ "index": { "_id": "7" } }</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="st">{ "product": "Elasticsearch Pen", "category": "Stationery", "price": 3.49 }</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="st">{ "index": { "_id": "8" } }</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="st">{ "product": "Elasticsearch Hoodie", "category": "Apparel", "price": 45.99 }    '</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<ol start="6" type="1">
<li><p>Perform a cross-cluster search query</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/remote_cluster:products/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-6" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-6">Test</h4>
<ol type="1">
<li><p>Verify the remote cluster info</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/_remote/info</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Search the remote cluster from the local cluster</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="er">GET</span> <span class="er">/remote_cluster:product_catalog/_search</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-6" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-6">Considerations</h4>
<ul>
<li>Ensure that the nodes listed in the seeds setting are accessible from the local cluster.</li>
<li>Security settings such as SSL/TLS should be configured to ensure secure communication between clusters.</li>
<li>Regularly monitor the connection status between the clusters to ensure reliability.</li>
</ul>
</section>
<section id="clean-up-optional-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional-4">Clean-up (optional)</h4>
<ul>
<li><p>Delete the <strong>es01</strong> index.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">products</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the <strong>es02</strong> index from the command line.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-u</span> elastic:[your password here] <span class="at">-X</span> DELETE <span class="st">"http://localhost:9201/products?pretty"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-6" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-6">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html" target="_blank">Cross-Cluster Search</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html" target="_blank">Cluster Remote Info API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html" target="_blank">Search API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html" target="_blank">Security Settings</a></li>
</ul>
</section>
</section>
</section>
<section id="task-implement-cross-cluster-replication" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="task-implement-cross-cluster-replication"><span class="header-section-number">5.5</span> Task: Implement cross-cluster replication</h2>
<p>There are a number of ways to set up cross-cluster replication and they can all be found <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html">here</a>.</p>
<p>Cross-cluster replication needs an <strong>Enterprise</strong> license</p>
<!--

***\[THERE SHOULD PROBABLY BE ONLY TWO EXAMPLES: FROM THE UI AND THE
CONSOLE\]***

The following is from
[a-step-by-step-guide-to-setting-up-ccr-elasticsearchreplication](https://triotechsystems.com/a-step-by-step-guide-to-setting-up-ccr-elasticsearch-replication/)

#### From the UI: Using Stack Management in Kibana{.unnumbered}

1. Open Kibana and navigate to Stack Management from the side
   navigation panel.

2. Select "Remote Clusters" to access the remote cluster configuration
   settings.

3. Specify the endpoint URL or the IP address/host name of the remote
   cluster (Cluster A), followed by the transport port (typically
   9300). For example, you can enter:

```json
"cluster.es.eastus2.staging.azure.foundit.no:9400" or
"192.168.1.1:9300"
```

as the remote cluster's connection details.

#### Using Kibana to set up the follower index{.unnumbered}

1. Open Kibana and navigate to Cross-Cluster Replication in the side
   navigation.

2. Select the "Follower Indices" tab.

3. Choose the cluster (Cluster A) that contains the leader index you
   want to replicate.

4. Enter the name of the leader index. In this tutorial, it's
   "kibana_sample_data_ecommerce."

5. Provide a name for your follower index, such as
   "follower-kibana-sample-data."

Elasticsearch will initialize the follower index using the remote
recovery process. This process transfers existing Lucene segment files
from the leader index to the follower index. Initially, the index status
will be "Paused." Once the remote recovery process completes, the index
status changes to "Active."

***(Optional) Setting up auto-follow for time series indices
replication*** 
To set up an auto-follow pattern using Kibana:

Access Kibana and navigate to Cross Cluster Replication in the side
navigation.

Select the "Auto-follow patterns" tab.

Provide a name for your auto-follow pattern, for instance, "beats."

Choose the remote cluster (Cluster A) that contains the index you want
to replicate.

Define one or more index patterns that identify the indices you want to
replicate from the remote cluster. For example, you can enter
"metricbeat-" and "packetbeat-" to automatically create followers for
Metricbeat and Packetbeat indices.

To make it easier to identify replicated indices, add "follower-" as a
prefix to the names of the follower indices.

With this setup, whenever new indices that match the specified patterns
are created on the remote cluster, Elasticsearch automatically initiates
their replication to local follower indices.

***Or from the Kibana Console:***

-->
<section id="example-1-setting-up-cross-cluster-replication-for-the-product-catalog-index-between-a-leader-cluster-and-a-follower-cluster" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="example-1-setting-up-cross-cluster-replication-for-the-product-catalog-index-between-a-leader-cluster-and-a-follower-cluster">Example 1: Setting up cross-cluster replication for the product catalog index between a leader cluster and a follower cluster</h3>
<p>In this example, we will run 2 single-node clusters locally using containers (as we have for all the other examples).</p>
<ul>
<li>The <strong>es01</strong> container instance will be considered
<ul>
<li>leader</li>
<li>remote</li>
</ul></li>
<li>The <strong>es02</strong> container instance will be considered
<ul>
<li>follower</li>
<li>local</li>
</ul></li>
</ul>
<p>You may also need to get a <strong>free 30-day trial license</strong> of certain features including cross-cluster replication. Since the second cluster is not hooked up to Kibana execute this from the command line (assuming you called the docker instance <strong>es02</strong> as we have been using in this guide):</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="at">-X</span> POST <span class="st">"http://localhost:9201/_license/start_trial?pretty&amp;acknowledge=true"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="requirements-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="requirements-7">Requirements</h4>
<ul>
<li>Configure remote cluster settings on both leader and follower clusters.</li>
<li>Set up the leader index on the leader cluster.</li>
<li>Configure the follower index on the follower cluster to replicate from the leader index.</li>
<li>Ensure secure communication between clusters.</li>
<li>Verify replication and data consistency.</li>
</ul>
</section>
<section id="steps-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="steps-7">Steps</h4>
<ol type="1">
<li><p><strong>Open the Kibana Console</strong> or use a REST client.</p></li>
<li><p>Configure the remote cluster settings on the <strong>leader</strong> cluster (<strong>es01</strong>)</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/_cluster/settings</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"persistent"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"cluster"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"remote"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"es01"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"seeds"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"es01:9300"</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"skip_unavailable"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"es02"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"seeds"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"es02:9300"</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"skip_unavailable"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Configure the local cluster settings on the <strong>follower</strong> cluster (<strong>es02</strong>)</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="at">-X</span> PUT <span class="st">"http://localhost:9201/_cluster/settings?pretty"</span> <span class="at">-H</span> <span class="st">"Content-Type: application/json"</span> <span class="at">-d</span><span class="st">'</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="st">  "persistent": {</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="st">    "cluster": {</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="st">      "remote": {</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="st">        "es01": {</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="st">        "seeds": [</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="st">            "es01:9300"</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="st">        ],</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="st">        "skip_unavailable": true</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="st">        },</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="st">        "es02": {</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="st">        "seeds": [</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="st">            "es02:9300"</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="st">        ],</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="st">        "skip_unavailable": false</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create the leader index on the <strong>leader</strong> cluster (<strong>es01</strong>)</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="er">PUT</span> <span class="er">/product_catalog</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"settings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"number_of_shards"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"number_of_replicas"</span><span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"mappings"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>     <span class="dt">"properties"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>     <span class="dt">"product_id"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>       <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"keyword"</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>     <span class="fu">},</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>     <span class="dt">"name"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>       <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"text"</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">},</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>     <span class="dt">"description"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>       <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"text"</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"price"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"double"</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Index sample documents in the <strong>leader</strong> index</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/product_catalog/_bulk</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"1"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product_id"</span><span class="fu">:</span> <span class="st">"p001"</span><span class="fu">,</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Product 1"</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Description of product 1"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">20.0</span> <span class="fu">}</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"_id"</span><span class="fu">:</span> <span class="st">"2"</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">"product_id"</span><span class="fu">:</span> <span class="st">"p002"</span><span class="fu">,</span> <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Product 2"</span><span class="fu">,</span> <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Description of product 2"</span><span class="fu">,</span> <span class="dt">"price"</span><span class="fu">:</span> <span class="fl">30.0</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Configure the follower index on the <strong>follower</strong> cluster through the command line</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="at">-X</span> PUT <span class="st">"http://localhost:9201/product_catalog_follower/_ccr/follow?pretty"</span> <span class="at">-H</span> <span class="st">"Content-Type: application/json"</span> <span class="at">-d</span><span class="st">'</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="st">  "remote_cluster": "es01",</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="st">  "leader_index": "product_catalog"</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="test-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="test-7">Test</h4>
<ol type="1">
<li><p>Verify the <strong>follower</strong> index (<strong>es02</strong>) is following the leader index</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="st">"http://localhost:9201/product_catalog_follower/_stats?pretty"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Check the data in the <strong>follower</strong> index (<strong>es02</strong>) to ensure it matches the <strong>leader</strong> (<strong>es01</strong>) index</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="st">"http://localhost:9201/product_catalog_follower/_search?pretty"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="considerations-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="considerations-7">Considerations</h4>
<ul>
<li>Ensure the nodes listed in the seeds setting are accessible from the follower cluster.</li>
<li>Security settings such as SSL/TLS should be configured to ensure secure communication between clusters (but not for this example given the YAML changes suggested in the <em>Appendix</em>).</li>
<li>Regularly monitor the replication status and performance to ensure data consistency and reliability.</li>
</ul>
</section>
<section id="clean-up-optional-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="clean-up-optional-5">Clean-up (optional)</h4>
<ul>
<li><p>Delete the <strong>follower</strong> configuration</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-v</span> <span class="at">-u</span> elastic:[YOUR ELASTIC PASSWORD HERE] <span class="at">-X</span> DELETE <span class="st">"http://localhost:9201/product_catalog_follower?pretty"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Delete the index</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="er">DELETE</span> <span class="er">product_catalog</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="documentation-7" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="documentation-7">Documentation</h4>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html" target="_blank">Cross-Cluster Replication</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-put-follow.html" target="_blank">Create Follower Index API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-remote-info.html" target="_blank">Cluster Remote Info API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html" target="_blank">Search API</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html" target="_blank">Security Settings</a></li>
</ul>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./4-data-processing.html" class="pagination-link" aria-label="Data Processing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Processing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./6-appendix.html" class="pagination-link" aria-label="Appendix">
        <span class="nav-page-text">Appendix</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>